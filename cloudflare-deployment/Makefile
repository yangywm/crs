# CRS Cloudflare éƒ¨ç½² Makefile
# æä¾›ä¾¿æ·çš„éƒ¨ç½²å’Œç®¡ç†å‘½ä»¤

.PHONY: help install deploy dev clean migrate test lint format

# é»˜è®¤ç›®æ ‡
help:
	@echo "CRS Cloudflare éƒ¨ç½²å·¥å…·"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  install     å®‰è£…ä¾èµ–å’Œåˆå§‹åŒ–ç¯å¢ƒ"
	@echo "  setup       é…ç½®Cloudflareèµ„æºå’Œç¯å¢ƒå˜é‡"
	@echo "  deploy      éƒ¨ç½²åˆ°Cloudflareå¹³å°"
	@echo "  dev         å¯åŠ¨æœ¬åœ°å¼€å‘ç¯å¢ƒ"
	@echo "  migrate     è¿è¡Œæ•°æ®è¿ç§»"
	@echo "  test        è¿è¡Œæµ‹è¯•"
	@echo "  lint        ä»£ç æ£€æŸ¥"
	@echo "  format      ä»£ç æ ¼å¼åŒ–"
	@echo "  clean       æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
	@echo "  logs        æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—"
	@echo "  status      æ£€æŸ¥éƒ¨ç½²çŠ¶æ€"

# å®‰è£…ä¾èµ–
install:
	@echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
	@if ! command -v wrangler >/dev/null 2>&1; then \
		echo "å®‰è£… Wrangler CLI..."; \
		npm install -g wrangler; \
	fi
	@if ! command -v jq >/dev/null 2>&1; then \
		echo "è¯·å®‰è£… jq: apt-get install jq æˆ– brew install jq"; \
		exit 1; \
	fi
	cd workers && npm install
	cd pages && npm install
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

# é…ç½®ç¯å¢ƒ
setup: install
	@echo "âš™ï¸ é…ç½®Cloudflareç¯å¢ƒ..."
	chmod +x scripts/setup-env.sh
	./scripts/setup-env.sh
	@echo "âœ… ç¯å¢ƒé…ç½®å®Œæˆ"

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
deploy: setup
	@echo "ğŸš€ éƒ¨ç½²åˆ°Cloudflare..."
	chmod +x deploy.sh
	./deploy.sh
	@echo "âœ… éƒ¨ç½²å®Œæˆ"

# éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
deploy-dev:
	@echo "ğŸš€ éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
	cd workers && wrangler deploy --env development
	cd pages && wrangler pages deploy dist --project-name crs-pages-dev
	@echo "âœ… å¼€å‘ç¯å¢ƒéƒ¨ç½²å®Œæˆ"

# æœ¬åœ°å¼€å‘ç¯å¢ƒ
dev:
	@echo "ğŸ› ï¸ å¯åŠ¨æœ¬åœ°å¼€å‘ç¯å¢ƒ..."
	docker-compose -f docker-compose.dev.yml up -d
	@echo "âœ… å¼€å‘ç¯å¢ƒå·²å¯åŠ¨"
	@echo "Workers: http://localhost:8787"
	@echo "Pages: http://localhost:3001"
	@echo "SQLite Web: http://localhost:8080"

# åœæ­¢å¼€å‘ç¯å¢ƒ
dev-stop:
	@echo "ğŸ›‘ åœæ­¢å¼€å‘ç¯å¢ƒ..."
	docker-compose -f docker-compose.dev.yml down
	@echo "âœ… å¼€å‘ç¯å¢ƒå·²åœæ­¢"

# æ•°æ®è¿ç§»
migrate:
	@echo "ğŸ”„ è¿è¡Œæ•°æ®è¿ç§»..."
	@if [ -f "../.env" ]; then \
		echo "æ£€æµ‹åˆ°ç°æœ‰Redisé…ç½®ï¼Œå¼€å§‹è¿ç§»..."; \
		node scripts/migrate-data.js; \
	else \
		echo "æœªæ£€æµ‹åˆ°ç°æœ‰é…ç½®ï¼Œè·³è¿‡è¿ç§»"; \
	fi
	cd workers && wrangler d1 migrations apply crs-database --remote
	@echo "âœ… æ•°æ®è¿ç§»å®Œæˆ"

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	cd workers && npm test
	cd pages && npm test
	@echo "âœ… æµ‹è¯•å®Œæˆ"

# ä»£ç æ£€æŸ¥
lint:
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	cd workers && npm run lint
	cd pages && npm run lint
	@echo "âœ… ä»£ç æ£€æŸ¥å®Œæˆ"

# ä»£ç æ ¼å¼åŒ–
format:
	@echo "âœ¨ ä»£ç æ ¼å¼åŒ–..."
	cd workers && npm run format
	cd pages && npm run format
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
	rm -rf workers/node_modules
	rm -rf pages/node_modules
	rm -rf pages/dist
	rm -rf migration-data
	rm -rf dev-data
	docker-compose -f docker-compose.dev.yml down -v
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—
logs:
	@echo "ğŸ“‹ æŸ¥çœ‹Workersæ—¥å¿—..."
	cd workers && wrangler tail

# æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
status:
	@echo "ğŸ“Š æ£€æŸ¥éƒ¨ç½²çŠ¶æ€..."
	@echo "WorkersçŠ¶æ€:"
	cd workers && wrangler status
	@echo ""
	@echo "PagesçŠ¶æ€:"
	cd pages && wrangler pages project list
	@echo ""
	@echo "D1æ•°æ®åº“:"
	wrangler d1 list
	@echo ""
	@echo "KVå‘½åç©ºé—´:"
	wrangler kv:namespace list
	@echo ""
	@echo "R2å­˜å‚¨æ¡¶:"
	wrangler r2 bucket list

# æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
update:
	@echo "ğŸ”„ æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬..."
	git pull origin main
	cd workers && npm update
	cd pages && npm update
	@echo "âœ… æ›´æ–°å®Œæˆ"

# å¤‡ä»½é…ç½®
backup:
	@echo "ğŸ’¾ å¤‡ä»½é…ç½®..."
	mkdir -p backups/$(shell date +%Y%m%d_%H%M%S)
	cp -r workers/wrangler.toml backups/$(shell date +%Y%m%d_%H%M%S)/
	cp -r workers/.env backups/$(shell date +%Y%m%d_%H%M%S)/ 2>/dev/null || true
	cp -r pages/.env backups/$(shell date +%Y%m%d_%H%M%S)/ 2>/dev/null || true
	@echo "âœ… é…ç½®å·²å¤‡ä»½åˆ° backups/"

# æ¢å¤é…ç½®
restore:
	@echo "ğŸ“¥ æ¢å¤é…ç½®..."
	@echo "å¯ç”¨å¤‡ä»½:"
	@ls -la backups/
	@echo "è¯·æ‰‹åŠ¨é€‰æ‹©è¦æ¢å¤çš„å¤‡ä»½ç›®å½•"

# ç›‘æ§èµ„æºä½¿ç”¨
monitor:
	@echo "ğŸ“ˆ ç›‘æ§èµ„æºä½¿ç”¨..."
	@echo "Workersè¯·æ±‚ç»Ÿè®¡:"
	cd workers && wrangler analytics
	@echo ""
	@echo "Pagesè®¿é—®ç»Ÿè®¡:"
	cd pages && wrangler pages analytics

# å®‰å…¨æ£€æŸ¥
security:
	@echo "ğŸ”’ å®‰å…¨æ£€æŸ¥..."
	@echo "æ£€æŸ¥æ•æ„Ÿä¿¡æ¯æ³„éœ²..."
	@if grep -r "sk-" workers/ pages/ 2>/dev/null; then \
		echo "âš ï¸ å‘ç°å¯èƒ½çš„APIå¯†é’¥æ³„éœ²"; \
	else \
		echo "âœ… æœªå‘ç°æ•æ„Ÿä¿¡æ¯æ³„éœ²"; \
	fi
	@echo "æ£€æŸ¥é…ç½®æ–‡ä»¶æƒé™..."
	@find . -name "*.env" -exec ls -la {} \;

# æ€§èƒ½æµ‹è¯•
benchmark:
	@echo "âš¡ æ€§èƒ½æµ‹è¯•..."
	@if command -v ab >/dev/null 2>&1; then \
		echo "è¿è¡ŒApache Benchæµ‹è¯•..."; \
		ab -n 100 -c 10 https://crs-api.your-subdomain.workers.dev/health; \
	else \
		echo "è¯·å®‰è£… apache2-utils æ¥è¿è¡Œæ€§èƒ½æµ‹è¯•"; \
	fi