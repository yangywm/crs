# GitHub Actions è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµ
# å½“æ¨é€åˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨éƒ¨ç½²åˆ°Cloudflare

name: Deploy to Cloudflare

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install Workers dependencies
      run: |
        cd cloudflare-deployment/workers
        npm ci

    - name: Install Pages dependencies
      run: |
        cd cloudflare-deployment/pages
        npm ci

    - name: Lint Workers code
      run: |
        cd cloudflare-deployment/workers
        npm run lint

    - name: Lint Pages code
      run: |
        cd cloudflare-deployment/pages
        npm run lint

    - name: Test Workers
      run: |
        cd cloudflare-deployment/workers
        npm test

  # éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
  deploy-dev:
    needs: lint-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    environment: development
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install Wrangler
      run: npm install -g wrangler

    - name: Install dependencies
      run: |
        cd cloudflare-deployment/workers
        npm ci
        cd ../pages
        npm ci

    - name: Deploy Workers to Dev
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      run: |
        cd cloudflare-deployment/workers
        wrangler deploy --env development

    - name: Build and Deploy Pages to Dev
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      run: |
        cd cloudflare-deployment/pages
        npm run build
        wrangler pages deploy dist --project-name crs-pages-dev

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-prod:
    needs: lint-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install Wrangler
      run: npm install -g wrangler

    - name: Install dependencies
      run: |
        cd cloudflare-deployment/workers
        npm ci
        cd ../pages
        npm ci

    - name: Run database migrations
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      run: |
        cd cloudflare-deployment/workers
        wrangler d1 migrations apply crs-database --remote

    - name: Deploy Workers to Production
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      run: |
        cd cloudflare-deployment/workers
        wrangler deploy --env production

    - name: Build and Deploy Pages to Production
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      run: |
        cd cloudflare-deployment/pages
        npm run build
        wrangler pages deploy dist --project-name crs-pages

    - name: Notify deployment success
      if: success()
      run: |
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
        echo "Workers: https://crs-api.your-subdomain.workers.dev"
        echo "Pages: https://crs-pages.pages.dev"

  # å®‰å…¨æ‰«æ
  security-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run security audit
      run: |
        cd cloudflare-deployment/workers
        npm audit --audit-level moderate
        cd ../pages
        npm audit --audit-level moderate

    - name: Check for secrets
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„å¯†é’¥
        if grep -r "sk-\|pk_\|API_KEY\|SECRET" cloudflare-deployment/ --exclude-dir=node_modules --exclude="*.md" --exclude="*.example"; then
          echo "âš ï¸ å‘ç°å¯èƒ½çš„ç¡¬ç¼–ç å¯†é’¥"
          exit 1
        fi